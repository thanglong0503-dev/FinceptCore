import streamlit as st
import random
from utils.data_fetcher import MarketDataEngine

st.title("ğŸ¤– Há»™i Äá»“ng Äáº§u TÆ° AI (AI Investment Committee)")
st.markdown("MÃ´ phá»ng quy trÃ¬nh ra quyáº¿t Ä‘á»‹nh vá»›i cÃ¡c nhÃ¢n cÃ¡ch nhÃ  Ä‘áº§u tÆ° huyá»n thoáº¡i.")

# 1. Cáº¥u hÃ¬nh NhÃ¢n cÃ¡ch (Persona Configuration) - [23]
personas = {
    "Warren Buffett": {
        "style": "Äáº§u tÆ° GiÃ¡ trá»‹ (Value Investing)",
        "focus": "Lá»£i tháº¿ cáº¡nh tranh (Moat), DÃ²ng tiá»n, Náº¯m giá»¯ dÃ i háº¡n, Äáº¡o Ä‘á»©c ban lÃ£nh Ä‘áº¡o.",
        "avatar": "ğŸ”",
        "system_prompt": "Báº¡n lÃ  Warren Buffett. HÃ£y táº­p trung vÃ o giÃ¡ trá»‹ ná»™i táº¡i, biÃªn an toÃ n vÃ  lá»£i tháº¿ cáº¡nh tranh bá»n vá»¯ng. HÃ£y hoÃ i nghi vá» cÃ¡c cÃ´ng nghá»‡ má»›i ná»•i mÃ  khÃ´ng cÃ³ dÃ²ng tiá»n rÃµ rÃ ng."
    },
    "Ray Dalio": {
        "style": "VÄ© mÃ´ ToÃ n cáº§u (Global Macro)",
        "focus": "Chu ká»³ kinh táº¿, Giáº£m Ä‘Ã²n báº©y (De-leveraging), Äa dáº¡ng hÃ³a, Risk Parity.",
        "avatar": "ğŸŒ",
        "system_prompt": "Báº¡n lÃ  Ray Dalio. HÃ£y phÃ¢n tÃ­ch dá»±a trÃªn cá»— mÃ¡y kinh táº¿ hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o. Xem xÃ©t láº¡m phÃ¡t, lÃ£i suáº¥t vÃ  vá»‹ trÃ­ cá»§a chÃºng ta trong chu ká»³ ná»£ lá»›n."
    },
    "Jim Simons": {
        "style": "Äáº§u tÆ° Äá»‹nh lÆ°á»£ng (Quantitative)",
        "focus": "Nháº­n dáº¡ng máº«u hÃ¬nh, Báº¥t thÆ°á»ng thá»‘ng kÃª, Táº§n suáº¥t cao, TÆ°Æ¡ng quan.",
        "avatar": "ğŸ“",
        "system_prompt": "Báº¡n lÃ  Jim Simons. Bá» qua cÃ¡c cÃ¢u chuyá»‡n ká»ƒ (narratives). Chá»‰ táº­p trung vÃ o dá»¯ liá»‡u, xu hÆ°á»›ng thá»‘ng kÃª, Ä‘á»™ lá»‡ch chuáº©n vÃ  tÃ­n hiá»‡u toÃ¡n há»c."
    }
}

col_p1, col_p2 = st.columns([2, 3])
with col_p1:
    selected_persona = st.radio("Chá»n Cá»‘ váº¥n:", list(personas.keys()))
    st.image(f"https://placehold.co/150x150/222/FFF/png?text={personas[selected_persona]['avatar']}", caption=selected_persona)

with col_p2:
    st.info(f"**PhÆ°Æ¡ng phÃ¡p:** {personas[selected_persona]['style']}\n\n**Trá»ng tÃ¢m:** {personas[selected_persona]['focus']}")
    
    # 2. Ngá»¯ cáº£nh Dá»¯ liá»‡u (Context Injection - Simulated RAG)
    ticker = st.session_state.current_ticker
    fund_data = MarketDataEngine.get_fundamental_info(ticker)
    
    # Táº¡o ngá»¯ cáº£nh (Context) tá»« dá»¯ liá»‡u thá»±c Ä‘á»ƒ gá»­i cho AI
    # Trong thá»±c táº¿, Ä‘Ã¢y sáº½ lÃ  payload gá»­i tá»›i OpenAI/Anthropic API
    if fund_data and 'info' in fund_data:
        pe_ratio = fund_data['info'].get('trailingPE', 'N/A')
        beta = fund_data['info'].get('beta', 'N/A')
        context_str = f"MÃ£: {ticker}, P/E: {pe_ratio}, Beta: {beta}."
    else:
        context_str = f"MÃ£: {ticker} (Dá»¯ liá»‡u háº¡n cháº¿)."

    # 3. Giao diá»‡n Chat
    if "messages" not in st.session_state:
        st.session_state.messages =

    # Hiá»ƒn thá»‹ lá»‹ch sá»­ chat
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # Xá»­ lÃ½ Ä‘áº§u vÃ o ngÆ°á»i dÃ¹ng
    if prompt := st.chat_input(f"Há»i {selected_persona} vá» {ticker}..."):
        # ThÃªm tin nháº¯n ngÆ°á»i dÃ¹ng vÃ o lá»‹ch sá»­
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # 4. Giáº£ láº­p Pháº£n há»“i AI (Simulated AI Response)
        # Trong production, thay Ä‘oáº¡n nÃ y báº±ng `client.chat.completions.create(...)`
        with st.chat_message("assistant", avatar=personas[selected_persona]['avatar']):
            with st.spinner(f"{selected_persona} Ä‘ang phÃ¢n tÃ­ch dá»¯ liá»‡u {ticker}..."):
                time.sleep(1.5) # Giáº£ láº­p Ä‘á»™ trá»… suy nghÄ©
                
                # Logic pháº£n há»“i giáº£ láº­p dá»±a trÃªn nhÃ¢n cÃ¡ch
                response_prefix = f"**[{selected_persona} Analysis]**: "
                
                if selected_persona == "Warren Buffett":
                    advice = f"Äá»‘i vá»›i {ticker}, Ä‘iá»u Ä‘áº§u tiÃªn tÃ´i nhÃ¬n vÃ o lÃ  con hÃ o kinh táº¿. Vá»›i P/E hiá»‡n táº¡i lÃ  {pe_ratio}, tÃ´i cáº§n cháº¯c cháº¯n ráº±ng dÃ²ng tiá»n cá»§a há» sáº½ tÄƒng trÆ°á»Ÿng Ä‘á»u Ä‘áº·n trong 10 nÄƒm tá»›i mÃ  khÃ´ng cáº§n tÃ¡i Ä‘áº§u tÆ° vá»‘n quÃ¡ nhiá»u. HÃ£y nhá»› quy táº¯c sá»‘ 1: Äá»«ng Ä‘á»ƒ máº¥t tiá»n."
                elif selected_persona == "Ray Dalio":
                    advice = f"ChÃºng ta Ä‘ang á»Ÿ giai Ä‘oáº¡n cuá»‘i cá»§a chu ká»³ ná»£ dÃ i háº¡n. {ticker} cÃ³ Ä‘á»™ biáº¿n Ä‘á»™ng (Beta: {beta}) cáº§n Ä‘Æ°á»£c cÃ¢n nháº¯c trong bá»‘i cáº£nh danh má»¥c Ä‘áº§u tÆ° 'All Weather'. Liá»‡u tÃ i sáº£n nÃ y cÃ³ hoáº¡t Ä‘á»™ng tá»‘t khi láº¡m phÃ¡t Ä‘Ã¬nh trá»‡ (stagflation) xáº£y ra khÃ´ng?"
                else: # Jim Simons
                    advice = f"CÃ¡c tÃ­n hiá»‡u thá»‘ng kÃª cho tháº¥y sá»± phÃ¢n ká»³ trong ngáº¯n háº¡n cá»§a {ticker}. MÃ´ hÃ¬nh trung dung (mean reversion) cá»§a tÃ´i Ä‘ang phÃ¡t tÃ­n hiá»‡u cáº£nh bÃ¡o khi giÃ¡ lá»‡ch chuáº©n quÃ¡ xa so vá»›i Ä‘Æ°á»ng trung bÃ¬nh Ä‘á»™ng 200 ngÃ y."
                
                full_response = response_prefix + advice
                
                st.markdown(full_response)
                st.session_state.messages.append({"role": "assistant", "content": full_response})
